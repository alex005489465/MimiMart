version: '3.8'

# MimiMart 網關服務
# 包含 Nginx 反向代理和 Cloudflare Tunnel

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: mimimart-gateway-nginx
    restart: unless-stopped

    volumes:
      # 配置文件（唯讀掛載）
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro

      # 日誌（可選，用於調試）
      # - ./logs/nginx:/var/log/nginx

    networks:
      - mimimart-network

    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: mimimart-gateway-cloudflared
    restart: unless-stopped

    command: tunnel --config /etc/cloudflared/config.yml run

    volumes:
      # 配置目錄（唯讀掛載）
      # 包含 config.yml 和 credentials.json
      - ./cloudflared/config:/etc/cloudflared:ro

    networks:
      - mimimart-network

    depends_on:
      nginx:
        condition: service_healthy

    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'

    # 環境變數（可選）
    # environment:
    #   - TUNNEL_LOGLEVEL=info

# 網路配置
networks:
  mimimart-network:
    external: true
    name: mimimart-network

# 說明：
# 1. 所有服務都連接到現有的 mimimart-network
# 2. 無需映射主機端口，純內部通訊
# 3. cloudflared 透過 Cloudflare 網路對外提供服務
# 4. nginx 作為內部反向代理，轉發請求到後端容器
# 5. 配置文件以唯讀模式掛載，提高安全性
