server:
  port: 8080

spring:
  application:
    name: mimimart-backend

  # 檔案上傳配置
  servlet:
    multipart:
      max-file-size: 10MB      # 單一檔案最大大小
      max-request-size: 50MB   # 整個請求最大大小
      enabled: true

  # MySQL 8.4.6 資料庫配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      pool-name: MimiMart-HikariCP

  # JPA 配置 (MySQL 8 Dialect)
  jpa:
    database-platform: org.hibernate.dialect.MySQL8Dialect
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
        jdbc:
          batch_size: 20
    show-sql: ${JPA_SHOW_SQL}
    open-in-view: false

  # Flyway 配置
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  # Redis 配置
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}
      database: ${REDIS_DATABASE}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  # 郵件配置 (SMTP 模式使用)
  mail:
    host: ${MAIL_HOST:mailpit}
    port: ${MAIL_PORT:1025}
    username: ${MAIL_USERNAME:noreply@yourdomain.com}
    password: ${MAIL_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: ${MAIL_SMTP_AUTH:false}
          starttls:
            enable: ${MAIL_SMTP_STARTTLS:false}

# SpringDoc OpenAPI 配置
springdoc:
  api-docs:
    path: /swagger/v3/api-docs
  swagger-ui:
    path: /swagger/ui.html
    displayRequestDuration: true
    tryItOutEnabled: true
    defaultModelsExpandDepth: 1
    filter: false
    syntaxHighlight:
      theme: monokai
    # 注入自訂 JavaScript (暗色主題偵測器)
    use-root-path: true

application:
  version: @project.version@

# MimiMart 應用程式配置
app:
  base-url: ${APP_BASE_URL}
  frontend:
    url: ${APP_FRONTEND_URL}
  # 測試端點配置 (僅開發/測試環境啟用)
  test-endpoints:
    enabled: ${APP_TEST_ENDPOINTS_ENABLED:false}

# JWT 認證配置
jwt:
  # JWT 簽名金鑰 (生產環境請使用環境變數覆蓋)
  # 生成指令: openssl rand -base64 64
  secret: ${JWT_SECRET}
  # Access Token 有效期 (毫秒) - 會員 15 分鐘, 管理員 30 分鐘
  member-access-token-expiration: ${JWT_MEMBER_ACCESS_EXPIRATION}
  admin-access-token-expiration: ${JWT_ADMIN_ACCESS_EXPIRATION}
  # Refresh Token 有效期 (毫秒) - 7 天
  refresh-token-expiration: ${JWT_REFRESH_EXPIRATION}

# Mailpit 測試郵件服務配置 (可選)
mailpit:
  api-url: ${MAILPIT_API_URL}

# AWS S3 配置
aws:
  region: ${AWS_REGION}
  s3:
    bucket-name: ${S3_BUCKET_NAME}
    public-bucket-name: ${S3_PUBLIC_BUCKET_NAME}
    public-base-url: ${S3_PUBLIC_BASE_URL}
  credentials:
    access-key-id: ${AWS_ACCESS_KEY_ID}
    secret-access-key: ${AWS_SECRET_ACCESS_KEY}

# MimiMart 業務配置
mimimart:
  # 付款配置
  payment:
    expiration-minutes: 30  # 付款期限(分鐘)
    expired-check-cron: "0 */5 * * * ?"  # 逾期檢查排程(每5分鐘)
  # ECPay 綠界金流配置
  ecpay:
    merchant-id: ${ECPAY_MERCHANT_ID}
    hash-key: ${ECPAY_HASH_KEY}
    hash-iv: ${ECPAY_HASH_IV}
    api-url: ${ECPAY_API_URL}
    return-url: ${ECPAY_RETURN_URL}
    callback-url: ${ECPAY_CALLBACK_URL}
  # 郵件服務配置
  email:
    # 郵件發送策略 (smtp | resend | aws-ses)
    provider: ${EMAIL_PROVIDER:smtp}
    # 寄件者資訊 (所有模式共用)
    from:
      address: ${MAIL_FROM_ADDRESS:noreply@yourdomain.com}
      name: ${MAIL_FROM_NAME:MimiMart}
    # Resend 配置 (當 provider=resend 時使用)
    resend:
      api-key: ${RESEND_API_KEY:}
    # AWS SES 配置 (當 provider=aws-ses 時使用，已廢棄)
    aws:
      ses:
        region: ${AWS_REGION:ap-south-1}
    # 郵件配額配置 (兩種模式共用)
    quota:
      monthly-limit: ${EMAIL_MONTHLY_LIMIT}  # 每月發信上限
      alert-thresholds: ${EMAIL_ALERT_THRESHOLDS}  # 告警閾值(%)
    # 郵件頻率限制 (兩種模式共用)
    rate-limit:
      verification:
        max-attempts: ${EMAIL_VERIFICATION_MAX_ATTEMPTS}  # 驗證郵件最大次數
        window-minutes: ${EMAIL_VERIFICATION_WINDOW_MINUTES}  # 時間窗口(分鐘)
      password-reset:
        max-attempts: ${EMAIL_PASSWORD_RESET_MAX_ATTEMPTS}  # 密碼重設最大次數
        window-minutes: ${EMAIL_PASSWORD_RESET_WINDOW_MINUTES}  # 時間窗口(分鐘)
  # AI 服務配置
  ai:
    # OpenAI 配置 (DALL-E 圖片生成)
    openai:
      api-key: ${OPENAI_API_KEY}
      api-url: ${OPENAI_API_URL:https://api.openai.com/v1}
      model: ${OPENAI_MODEL:dall-e-3}
      image-size: ${OPENAI_IMAGE_SIZE:1024x1024}
      image-quality: ${OPENAI_IMAGE_QUALITY:standard}  # standard | hd
    # Deepseek 配置 (文字生成)
    deepseek:
      api-key: ${DEEPSEEK_API_KEY}
      api-url: ${DEEPSEEK_API_URL:https://api.deepseek.com/v1}
      model: ${DEEPSEEK_MODEL:deepseek-chat}

# 日誌配置
logging:
  level:
    root: ${LOG_LEVEL_ROOT}
    com.mimimart: ${LOG_LEVEL_APP}
    org.springframework.web: ${LOG_LEVEL_WEB}
    org.hibernate.SQL: ${LOG_LEVEL_SQL}
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOG_LEVEL_SQL_BINDER}
